<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>h5camera</title>
    <style>
        .outscreen {
            display: block;
            position: absolute;
            top: -6000px;
        }

        .btn {
            height: 30px;
            width: 100px;
            line-height: 30px;
            border: 1px solid #ccc;
            text-align: center
        }

        .btn:hover {
            background: #ccc
        }

        .album img {
            width: 60px;
        }
    </style>
</head>

<body>
    <video id="video" width="640" height="480" class="outscreen"></video>
    <!-- <canvas id="tmpCanvas" width="640" height="480" style="display:none"></canvas> -->
    <canvas id="canvas" width="640" height="480"></canvas>

    <div class="btn capture">拍照</div>

    <div class="album"></div>

    <script>
        window.navigator.getUserMedia = navigator.getUserMedia || navigator.webKitGetUserMedia || navigator
            .mozGetUserMedia || navigator.msGetUserMedia;


        (function () {
            var lastTime = 0;
            var vendors = ['webkit', 'moz'];
            for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
                window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] ||
                    // name has changed in Webkit
                    window[vendors[x] + 'CancelRequestAnimationFrame'];
            }
            if (!window.requestAnimationFrame) {
                window.requestAnimationFrame = function (callback, element) {
                    var currTime = new Date().getTime();
                    var timeToCall = Math.max(0, 16.7 - (currTime - lastTime));
                    var id = window.setTimeout(function () {
                        callback(currTime + timeToCall);
                    }, timeToCall);
                    lastTime = currTime + timeToCall;
                    return id;
                };
            }
            if (!window.cancelAnimationFrame) {
                window.cancelAnimationFrame = function (id) {
                    clearTimeout(id);
                };
            }
        }());


        var video = document.querySelector('video');
        // var tmpCanvas = document.getElementById("tmpCanvas");
        var canvas = document.getElementById("canvas");
        canvas.width = 320, canvas.height = 456;
        var ctx = canvas.getContext('2d');
        var capture = document.querySelector(".capture")

        capture.addEventListener("click", function () {

            // var img = document.getElementById("save_img");

            var img = document.createElement("img")
            var tempSrc = canvas.toDataURL("image/png");

            // svaeHref.href=tempSrc;

            img.src = tempSrc;
            // img

            document.querySelector(".album").appendChild(img)



        });


        // drawGrid('#09f', 10, 10);
        function drawGrid(color, stepx, stepy) {
            ctx.save()

            ctx.strokeStyle = color;
            ctx.lineWidth = 0.5;
            // ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            for (var i = stepx + 0.5; i < ctx.canvas.width; i += stepx) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, ctx.canvas.height);
                ctx.stroke();
            }

            for (var i = stepy + 0.5; i < ctx.canvas.height; i += stepy) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(ctx.canvas.width, i);
                ctx.stroke();
            }
            ctx.restore();
        }

        var videoToCanvas = function (video) {
            if (video)
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
            ctx.font = "30px sans-serif";
            ctx.fillStyle = "blue";
            ctx.fillText("请眨眼", 50, 50);

            drawGrid('#000', 30, 30);
            // var ctx2 = this.cas.getContext('2d');
            //         ctx2.drawImage(cs , -this.cols*this.w , -this.rows*this.h , vw , vh);
        }
        var timer;


        function invokingCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                //新API MediaDevices.getUserMedia可以通过video的facingMode属性指定调用手机的前置或后置摄像头
                // console.log(222);
                navigator.mediaDevices.getUserMedia({
                        'audio': false,
                        'video': {
                            // 'facingMode': "user"
                            video: { facingMode: { exact: "environment" } }
                        } //调用前置摄像头
                        // video: { facingMode: { exact: "environment" } }//后置
                        //                     {
                        //   audio: true,
                        //   video: {
                        //     width: { min: 1024, ideal: 1280, max: 1920 },
                        //     height: { min: 776, ideal: 720, max: 1080 }
                        //   }
                        // }

                    })
                    .then(function (mediaStream) {
                        video.srcObject = mediaStream;
                        video.onloadedmetadata = function (e) {
                            video.play();
                        };

                        video.addEventListener('play', function () {
                            // var loop = function () {
                            //     videoToCanvas(video)
                            //     timer = requestAnimationFrame(loop)
                            // }
                            // loop()

                            timer=  setInterval(function(){
                                videoToCanvas(video)
                            },30)
                        }, false);
                        video.addEventListener('pause', function () {
                            // cancelAnimationFrame(timer);
                            clearInterval(timer)
                        }, false);
                        video.addEventListener('ended', function () {
                            // cancelAnimationFrame(timer);
                            clearInterval(timer)
                        }, false);
                    })
                    .catch(function (error) {
                        console.log(error)
                    })
            } else if (navigator.getUserMedia) {
                //navigator.getUserMediau已经从 Web 标准中删除，部分浏览器可以使用
                navigator.getUserMedia({
                    'video': true,
                    'audio': true
                }, getVideoStream, getFail)
            } else {
                alert('不支持摄像头调用！')
            }
        }
        //调用成功
        function getVideoStream(stream) {
            buffer = stream;
            // if(video.mozSrcObject !== undefined){
            //     video.mozSrcObject = buffer;
            // }else{
            video.src = window.URL && window.URL.createObjectURL(buffer)
            // }
        }

        function getFail() {

        }


        function closeCamera() {
            // buffer && buffer.getTracks()[1].stop(); //关闭摄像头
            // var video = document.querySelector('video');
            // video.close();
        }

        window.addEventListener("load", function () {
            invokingCamera()
            // videoToCanvas()
        })
    </script>

</body>

</html>